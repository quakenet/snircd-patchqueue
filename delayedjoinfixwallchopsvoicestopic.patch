# HG changeset patch
# Parent b33cb8c0208a4fa055b080122febcbee502d9dae

Reveal Delayedjoin user when sending wallchops and wallvoices, or changing the channel topic.

Backport from snircd 1.4.0

http://hg.quakenet.org/snircd/rev/1b452072b7d2
http://hg.quakenet.org/snircd/rev/009cf0ea7cb8

diff -r b33cb8c0208a ircd/m_topic.c
--- a/ircd/m_topic.c
+++ b/ircd/m_topic.c
@@ -72,8 +72,18 @@
      sendcmdto_serv_butone(sptr, CMD_TOPIC, cptr, "%H %Tu %Tu :%s", chptr,
 		           chptr->creationtime, chptr->topic_time, chptr->topic);
    if (newtopic)
+   {
+     struct Membership *member;
+
+     /* If the member is delayed-join, show them. */
+     member = find_channel_member(sptr, chptr);
+     if (member && IsDelayedJoin(member))
+       RevealDelayedJoin(member);
+
      sendcmdto_channel_butserv_butone(from, CMD_TOPIC, chptr, NULL, 0,
       				       "%H :%s", chptr, chptr->topic);
+   }
+
       /* if this is the same topic as before we send it to the person that
        * set it (so they knew it went through ok), but don't bother sending
        * it to everyone else on the channel to save bandwidth
diff -r b33cb8c0208a ircd/m_wallchops.c
--- a/ircd/m_wallchops.c
+++ b/ircd/m_wallchops.c
@@ -102,6 +102,7 @@
 int m_wallchops(struct Client* cptr, struct Client* sptr, int parc, char* parv[])
 {
   struct Channel *chptr;
+  struct Membership* member;
   const char *ch;
 
   assert(0 != cptr);
@@ -134,6 +135,10 @@
             return 0;
           }
 
+      /* Reveal delayedjoin user */
+      if ((member = find_member_link(chptr, sptr)) && IsDelayedJoin(member))
+        RevealDelayedJoin(member);
+
       sendcmdto_channel_butone(sptr, CMD_WALLCHOPS, chptr, cptr,
 			       SKIP_DEAF | SKIP_BURST | SKIP_NONOPS,
 			       "%H :@ %s", chptr, parv[parc - 1]);
@@ -160,7 +165,7 @@
     return 0;
 
   if (!IsLocalChannel(parv[1]) && (chptr = FindChannel(parv[1]))) {
-    if (client_can_send_to_channel(sptr, chptr, 0)) {
+    if (client_can_send_to_channel(sptr, chptr, 1)) {
       sendcmdto_channel_butone(sptr, CMD_WALLCHOPS, chptr, cptr,
 			       SKIP_DEAF | SKIP_BURST | SKIP_NONOPS,
 			       "%H :%s", chptr, parv[parc - 1]);
diff -r b33cb8c0208a ircd/m_wallvoices.c
--- a/ircd/m_wallvoices.c
+++ b/ircd/m_wallvoices.c
@@ -101,6 +101,7 @@
 int m_wallvoices(struct Client* cptr, struct Client* sptr, int parc, char* parv[])
 {
   struct Channel *chptr;
+  struct Membership* member;
   const char *ch;
 
   assert(0 != cptr);
@@ -133,6 +134,10 @@
             return 0;
           }
 
+      /* Reveal delayedjoin user */
+      if ((member = find_member_link(chptr, sptr)) && IsDelayedJoin(member))
+        RevealDelayedJoin(member);
+
       sendcmdto_channel_butone(sptr, CMD_WALLVOICES, chptr, cptr,
 			       SKIP_DEAF | SKIP_BURST | SKIP_NONVOICES, 
 			       "%H :+ %s", chptr, parv[parc - 1]);
@@ -159,7 +164,7 @@
     return 0;
 
   if (!IsLocalChannel(parv[1]) && (chptr = FindChannel(parv[1]))) {
-    if (client_can_send_to_channel(sptr, chptr, 0)) {
+    if (client_can_send_to_channel(sptr, chptr, 1)) {
       sendcmdto_channel_butone(sptr, CMD_WALLVOICES, chptr, cptr,
 			       SKIP_DEAF | SKIP_BURST | SKIP_NONVOICES, 
 			       "%H :%s", chptr, parv[parc - 1]);
