# HG changeset patch
# Parent c241774dec3286e7d620a5e5ea7355461c39b9af

Hide IRC Operators nick in the channel banlist for bans set using /OPMODE

Backport from snircd 1.4.0 - http://hg.quakenet.org/snircd/rev/9a188302ba56

diff -r c241774dec32 ircd/channel.c
--- a/ircd/channel.c
+++ b/ircd/channel.c
@@ -2937,7 +2937,16 @@
   newban->flags = ((state->dir == MODE_ADD) ? BAN_ADD : BAN_DEL)
       | (*flag_p == MODE_BAN ? 0 : BAN_EXCEPTION);
   set_ban_mask(newban, collapse(pretty_mask(t_str)));
-  ircd_strncpy(newban->who, IsUser(state->sptr) ? cli_name(state->sptr) : "*", NICKLEN);
+
+  /* source not a user OR feat HIS_MODEWHO enabled and ban set with /OPMODE
+    so hide the source in banlist - snircd */
+  if (!IsUser(state->sptr) || 
+    (feature_bool(FEAT_HIS_MODEWHO) && state->mbuf != NULL && (state->mbuf->mb_dest & MODEBUF_DEST_OPMODE))) {
+    ircd_strncpy(newban->who, "*", NICKLEN);
+  } else {
+    ircd_strncpy(newban->who, cli_name(state->sptr), NICKLEN);
+  }
+
   newban->when = TStime();
   apply_ban(&state->chptr->banlist, newban, 0);
 }
